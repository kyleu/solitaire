"use strict";(()=>{var u=!1,m=!1,w=100;function p(t){if(t??="/connect",t.startsWith("ws"))return t;let e=document.location,n="ws";return e.protocol==="https:"&&(n="wss"),t.startsWith("/")||(t="/"+t),n+`://${e.host}${t}`}var d=class{constructor(e,n,s,o,r){this.debug=e,this.open=n,this.recv=s,this.err=o,this.url=p(r),this.connected=!1,this.pauseSeconds=1,this.pendingMessages=[],this.connect()}connect(){m||(window.addEventListener("beforeunload",()=>{u=!0}),m=!0),this.connectTime=Date.now(),this.sock=new WebSocket(p(this.url));let e=this;this.sock.onopen=()=>{e.connected=!0,e.pendingMessages.forEach(n=>{e.send(n)}),e.pendingMessages=[],e.debug&&console.log("WebSocket connected"),e.open()},this.sock.onmessage=n=>{let s;try{s=JSON.parse(String(n.data))}catch(o){e.err("socket",`invalid message payload: ${String(o)}`);return}e.debug&&console.debug("[socket]: receive",s),s.cmd==="close-connection"?e.disconnect():e.recv(s)},this.sock.onerror=n=>{e.err("socket",n.type)},this.sock.onclose=()=>{if(u||e.closed)return;e.connected=!1;let n=e.connectTime?Date.now()-e.connectTime:0;n>0&&n<2e3?(e.pauseSeconds=e.pauseSeconds*2,e.debug&&console.debug(`socket closed immediately, reconnecting in ${e.pauseSeconds.toString()} seconds`),setTimeout(()=>{e.connect()},e.pauseSeconds*1e3)):(console.debug("socket closed after ["+n.toString()+"ms]"),setTimeout(()=>{e.connect()},e.pauseSeconds*500))}}disconnect(){this.closed=!0,setTimeout(()=>{this.sock?.close(),console.debug("[socket] closed")},500)}send(e){if(this.debug&&console.debug("out",e),!this.sock)throw new Error("socket not initialized");if(this.connected){let n=JSON.stringify(e,null,2);this.sock.send(n)}else this.pendingMessages.push(e),this.pendingMessages.length>w&&this.pendingMessages.shift()}};function y(t,e){let n;e?n=e.querySelectorAll(t):n=document.querySelectorAll(t);let s=[];return n.forEach(o=>{s.push(o)}),s}function c(t,e){let n=y(t,e);switch(n.length){case 0:return;case 1:return n[0];default:console.warn(`found [${n.length.toString()}] elements with selector [${t}], wanted zero or one`);return}}function f(t,e){let n=c(t,e);if(!n)throw new Error(`no element found for selector [${t}]`);return n}function h(t){let e=c("#log-panel");if(e){let n=document.createElement("tr"),s=document.createElement("th");s.innerText=e.children.length.toString();let o=document.createElement("td");o.innerText=t,n.append(s,o),e.append(n);let r=document.getElementById("content");r.scrollTo(0,r.scrollHeight)}else console.log("[no-log-panel]: "+t)}var a=class{init(e,n){c("#loading-panel")?.remove(),f("#load-status").innerText="Loaded in ["+e+"ms]",log(`game [${n}] initialized in [${e}ms]`),sendGameMessage("welcome",{ruleset:n})}onInput(e,n){switch(e){case"save":sendGameMessage("save",{});break;case"testbed":h(JSON.stringify(n,null,2));break;default:console.log("unhandled input ["+e+"].");break}}},k;function g(t){k=t}function l(){return k}function S(t,e){g(new a),l().init(t,e)}function v(t,e,n){g(new a);function s(){l().init(t,n)}function o(i){T(l(),i.param)}function r(i){console.log("[socket error]: "+i)}let b=new d(!1,s,o,r,e);globalThis.log=i=>console.log(i),globalThis.sendGameMessage=(i,M)=>{b.send({channel:"game",cmd:"message",param:{t:i,data:M}})}}function T(t,e){console.log("received message: "+JSON.stringify(e))}globalThis.wasmInit=S;globalThis.websocketInit=v;globalThis.onClientMessage=t=>T(l(),t);})();
//# sourceMappingURL=game.js.map
